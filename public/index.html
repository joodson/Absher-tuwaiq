<!-- public/index.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>بوابة الدخول - حجز المواعيد</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f7f8;
      color: #1f2933;
    }

    .app-header {
      background: linear-gradient(135deg, #0f7c4a, #0b5f39);
      color: #fff;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    .app-header .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-mark {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 2px solid #e2f7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 20px;
      background: rgba(0, 0, 0, 0.1);
    }

    .app-title-main {
      font-weight: 700;
      font-size: 18px;
    }

    .app-title-sub {
      font-size: 12px;
      opacity: 0.9;
    }

    .app-layout {
      max-width: 960px;
      margin: 32px auto;
      padding: 0 16px 32px;
    }

    .card {
      background: #ffffff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 16px rgba(15, 124, 74, 0.08);
      border-top: 4px solid #0f7c4a;
    }

    h1, h2, h3 {
      margin-top: 0;
      color: #123026;
    }

    .step-indicator {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      font-size: 13px;
      color: #4b5563;
      flex-wrap: wrap;
    }

    .step-pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: #e5f5ec;
      color: #0f7c4a;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .step-pill.inactive {
      background: #e5e7eb;
      color: #6b7280;
    }

    .step-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: currentColor;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      font-weight: 600;
    }

    input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #cbd5e1;
      font-size: 15px;
      box-sizing: border-box;
      direction: ltr;
      text-align: left;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #0f7c4a;
      box-shadow: 0 0 0 2px rgba(15, 124, 74, 0.2);
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }

    .btn-primary {
      background: #0f7c4a;
      color: #fff;
    }

    .btn-primary:hover {
      background: #0b5f39;
    }

    .btn-outline {
      background: #fff;
      border: 1px solid #0f7c4a;
      color: #0f7c4a;
    }

    .btn-outline:hover {
      background: #e5f5ec;
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }

    .btn-secondary:hover {
      background: #e5e7eb;
    }

    .mt-2 { margin-top: 8px; }
    .mt-3 { margin-top: 12px; }
    .mt-4 { margin-top: 16px; }
    .mt-5 { margin-top: 24px; }

    .alert {
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 13px;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-top: 12px;
    }

    .alert-info {
      background: #e0f2fe;
      color: #0369a1;
      border: 1px solid #7dd3fc;
    }

    .alert-error {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .alert-success {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .alert-icon {
      font-size: 16px;
      margin-top: 1px;
    }

    .hidden {
      display: none;
    }

    .verification-options {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 16px;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #e5f5ec;
      color: #0f7c4a;
      margin-right: 8px;
    }

    .camera-preview {
      margin-top: 16px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #d1d5db;
      max-width: 320px;
    }

    video {
      width: 100%;
      display: block;
    }

    .appointment-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px 24px;
      font-size: 14px;
      margin-top: 16px;
    }

    .appointment-label {
      font-weight: 600;
      color: #4b5563;
    }

    .appointment-value {
      color: #111827;
    }

    @media (max-width: 640px) {
      .appointment-grid {
        grid-template-columns: 1fr;
      }
    }

    .footer-note {
      margin-top: 16px;
      font-size: 11px;
      color: #6b7280;
      text-align: center;
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="logo">
      <div class="logo-mark">ب</div>
      <div>
        <div class="app-title-main">بوابة الدخول الذكية</div>
        <div class="app-title-sub">محاكاة نظام مواعيد الجهات الحكومية</div>
      </div>
    </div>
    <div style="font-size: 12px; opacity: 0.9;">
      نسخة تجريبية • بيانات وهمية لأغراض العرض فقط
    </div>
  </header>

  <main class="app-layout">
    <section class="card">
      <div class="step-indicator">
        <div class="step-pill" id="step-pill-1">
          <span class="step-dot"></span>
          ١. إدخال رقم الهوية
        </div>
        <div class="step-pill inactive" id="step-pill-2">
          <span class="step-dot"></span>
          ٢. التحقق بالبيانات الحيوية
        </div>
        <div class="step-pill inactive" id="step-pill-3">
          <span class="step-dot"></span>
          ٣. عرض تفاصيل الموعد
        </div>
      </div>

      <!-- Step 1: Enter National ID -->
      <div id="step-1">
        <h2>أدخل رقم الهوية الوطنية</h2>
        <p style="font-size: 14px; color: #4b5563;">
          الرجاء إدخال رقم الهوية للتحقق من وجود حجز مسبق في النظام.
        </p>

        <label for="nationalId">رقم الهوية الوطنية</label>
        <input
          type="text"
          id="nationalId"
          maxlength="10"
        />

        <button class="btn btn-primary mt-3" id="btnCheckId">
          التحقق من الموعد
        </button>

        <div class="alert alert-info mt-3">
          <span class="alert-icon">ℹ️</span>
          <span>هذه الواجهة تستخدم بيانات وهمية وهي لأغراض التدريب والعرض فقط، ولا ترتبط بأي أنظمة حكومية حقيقية.</span>
        </div>

        <div id="idError" class="alert alert-error mt-3 hidden">
          <span class="alert-icon">⚠️</span>
          <span id="idErrorMessage"></span>
        </div>
      </div>

      <!-- Step 2: Choose verification method -->
      <div id="step-2" class="hidden">
        <h2>اختر طريقة التحقق من الهوية</h2>
        <p style="font-size: 14px; color: #4b5563;">
          يمكنك التحقق باستخدام صورة شخصية أو باستخدام البصمة.
        </p>

        <div class="verification-options">
          <button class="btn btn-outline" id="btnUseSelfie">
             التحقق بالصورة
          </button>
          <button class="btn btn-outline" id="btnUseFingerprint">
             التحقق بالبصمة
          </button>
        </div>

        <!-- Selfie verification area -->
        <div id="selfieSection" class="hidden mt-4">
          <h3>
            التحقق بالصورة
            <span class="badge">تجريبي</span>
          </h3>
          <p style="font-size: 13px; color: #6b7280;">
            سيتم تشغيل الكاميرا لالتقاط صورة سريعة، ثم يتم إرسال طلب تحقق تجريبي للخادم.
          </p>

          <div class="camera-preview">
            <video id="videoPreview" autoplay playsinline></video>
          </div>

          <button class="btn btn-primary mt-3" id="btnVerifySelfie">
            التقاط والتحقق
          </button>

          <button class="btn btn-secondary mt-3" id="btnBackFromSelfie">
            رجوع لاختيار طريقة أخرى
          </button>

          <div id="selfieMessage" class="alert mt-3 hidden">
            <span class="alert-icon">ℹ️</span>
            <span id="selfieMessageText"></span>
          </div>
        </div>

        <!-- Fingerprint verification area -->
        <div id="fingerprintSection" class="hidden mt-4">
          <h3>
            التحقق بالبصمة
            <span class="badge">محاكاة</span>
          </h3>
          <p style="font-size: 13px; color: #6b7280;">
            في النظام الحقيقي، سيتم استخدام قارئ البصمة المتصل بالجهاز مع
            برمجيات متخصصة لمقارنة البصمة مع قاعدة البيانات. في هذا النموذج
            نقوم بمحاكاة العملية فقط.
          </p>

          <button class="btn btn-primary mt-3" id="btnSimulateFingerprint">
            محاكاة التحقق بالبصمة
          </button>

          <button class="btn btn-secondary mt-3" id="btnBackFromFingerprint">
            رجوع لاختيار طريقة أخرى
          </button>

          <div id="fingerprintMessage" class="alert mt-3 hidden">
            <span class="alert-icon">ℹ️</span>
            <span id="fingerprintMessageText"></span>
          </div>
        </div>

        <button class="btn btn-secondary mt-4" id="btnBackToId">
           العودة لخطوة رقم الهوية
        </button>
      </div>

      <!-- Step 3: Appointment details -->
      <div id="step-3" class="hidden">
        <h2>تفاصيل الموعد</h2>

        <div class="alert alert-success">
          <span class="alert-icon">✅</span>
          <span>تم التحقق من هوية صاحب الموعد بنجاح. يسمح له بالدخول.</span>
        </div>

        <div class="appointment-grid">
          <div class="appointment-label">الاسم الكامل</div>
          <div class="appointment-value" id="apFullName"></div>

          <div class="appointment-label">الخدمة</div>
          <div class="appointment-value" id="apService"></div>

          <div class="appointment-label">الموقع</div>
          <div class="appointment-value" id="apLocation"></div>

          <div class="appointment-label">التاريخ</div>
          <div class="appointment-value" id="apDate"></div>

          <div class="appointment-label">الوقت</div>
          <div class="appointment-value" id="apTime"></div>

          <div class="appointment-label">رقم التذكرة</div>
          <div class="appointment-value" id="apTicket"></div>

          <div class="appointment-label">ملاحظات</div>
          <div class="appointment-value" id="apNotes"></div>
        </div>

        <button class="btn btn-primary mt-4" id="btnNewVisitor">
          إنهاء والانتقال للزائر التالي
        </button>

        <div class="footer-note">
          هذا النظام للتجربة فقط ولا يمثل أي منصة رسمية.
        </div>
      </div>
    </section>
  </main>

  <script>
    const step1 = document.getElementById('step-1');
    const step2 = document.getElementById('step-2');
    const step3 = document.getElementById('step-3');

    const pill1 = document.getElementById('step-pill-1');
    const pill2 = document.getElementById('step-pill-2');
    const pill3 = document.getElementById('step-pill-3');

    const nationalIdInput = document.getElementById('nationalId');
    const btnCheckId = document.getElementById('btnCheckId');
    const idError = document.getElementById('idError');
    const idErrorMessage = document.getElementById('idErrorMessage');

    const btnUseSelfie = document.getElementById('btnUseSelfie');
    const btnUseFingerprint = document.getElementById('btnUseFingerprint');
    const btnBackToId = document.getElementById('btnBackToId');

    const selfieSection = document.getElementById('selfieSection');
    const fingerprintSection = document.getElementById('fingerprintSection');

    const videoPreview = document.getElementById('videoPreview');
    const btnVerifySelfie = document.getElementById('btnVerifySelfie');
    const btnBackFromSelfie = document.getElementById('btnBackFromSelfie');
    const selfieMessage = document.getElementById('selfieMessage');
    const selfieMessageText = document.getElementById('selfieMessageText');

    const btnSimulateFingerprint = document.getElementById('btnSimulateFingerprint');
    const btnBackFromFingerprint = document.getElementById('btnBackFromFingerprint');
    const fingerprintMessage = document.getElementById('fingerprintMessage');
    const fingerprintMessageText = document.getElementById('fingerprintMessageText');

    const apFullName = document.getElementById('apFullName');
    const apService = document.getElementById('apService');
    const apLocation = document.getElementById('apLocation');
    const apDate = document.getElementById('apDate');
    const apTime = document.getElementById('apTime');
    const apTicket = document.getElementById('apTicket');
    const apNotes = document.getElementById('apNotes');

    const btnNewVisitor = document.getElementById('btnNewVisitor');

    let currentNationalId = null;
    let currentStream = null;

    function setStep(stepNumber) {
      step1.classList.add('hidden');
      step2.classList.add('hidden');
      step3.classList.add('hidden');

      pill1.classList.add('inactive');
      pill2.classList.add('inactive');
      pill3.classList.add('inactive');

      if (stepNumber === 1) {
        step1.classList.remove('hidden');
        pill1.classList.remove('inactive');
      } else if (stepNumber === 2) {
        step2.classList.remove('hidden');
        pill2.classList.remove('inactive');
      } else if (stepNumber === 3) {
        step3.classList.remove('hidden');
        pill3.classList.remove('inactive');
      }
    }

    // Stop camera stream if running
    function stopCamera() {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
      }
    }

    // Step 1: Check ID
    btnCheckId.addEventListener('click', async () => {
      const id = nationalIdInput.value.trim();

      idError.classList.add('hidden');

      if (!id || id.length < 10) {
        idErrorMessage.textContent = 'الرجاء إدخال رقم هوية صحيح مكون من 10 أرقام.';
        idError.classList.remove('hidden');
        return;
      }

      try {
        const res = await fetch('/api/check-id', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nationalId: id })
        });

        const data = await res.json();

        if (!data.ok) {
          idErrorMessage.textContent = data.message || 'لا يوجد موعد مسجل لهذا الرقم.';
          idError.classList.remove('hidden');
          return;
        }

        currentNationalId = id;
        setStep(2);
      } catch (err) {
        idErrorMessage.textContent = 'حدث خطأ في الاتصال بالخادم. الرجاء المحاولة مرة أخرى.';
        idError.classList.remove('hidden');
      }
    });

    // Step 2: choose verification method
    btnUseSelfie.addEventListener('click', async () => {
      fingerprintSection.classList.add('hidden');
      selfieSection.classList.remove('hidden');
      selfieMessage.classList.add('hidden');

      // Start camera
      try {
        stopCamera();
        currentStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        videoPreview.srcObject = currentStream;
      } catch (err) {
        selfieMessage.classList.remove('hidden');
        selfieMessage.classList.add('alert-error');
        selfieMessageText.textContent = 'تعذر تشغيل الكاميرا. الرجاء التحقق من الأذونات.';
      }
    });

    btnBackFromSelfie.addEventListener('click', () => {
      selfieSection.classList.add('hidden');
      stopCamera();
    });

    btnUseFingerprint.addEventListener('click', () => {
      selfieSection.classList.add('hidden');
      stopCamera();
      fingerprintSection.classList.remove('hidden');
      fingerprintMessage.classList.add('hidden');
    });

    btnBackFromFingerprint.addEventListener('click', () => {
      fingerprintSection.classList.add('hidden');
    });

    btnBackToId.addEventListener('click', () => {
      selfieSection.classList.add('hidden');
      fingerprintSection.classList.add('hidden');
      stopCamera();
      setStep(1);
    });

    // Selfie verification (simulated)
    btnVerifySelfie.addEventListener('click', async () => {
      if (!currentNationalId) return;

      selfieMessage.className = 'alert mt-3';
      selfieMessage.classList.add('alert-info');
      selfieMessage.classList.remove('hidden');
      selfieMessageText.textContent = 'جاري إرسال طلب التحقق...';

      // In a real system, the system will capture a frame from the video and send it.
      try {
        const res = await fetch('/api/verify-selfie', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nationalId: currentNationalId })
        });

        const data = await res.json();

        if (!data.ok) {
          selfieMessage.className = 'alert mt-3 alert-error';
          selfieMessageText.textContent = data.message || 'فشل التحقق بالصورة.';
          return;
        }

        // Success -> show appointment
        fillAppointment(data.appointment);
        stopCamera();
        setStep(3);
      } catch (err) {
        selfieMessage.className = 'alert mt-3 alert-error';
        selfieMessageText.textContent = 'حدث خطأ في الاتصال بالخادم.';
      }
    });

    // Fingerprint verification (simulated)
    btnSimulateFingerprint.addEventListener('click', async () => {
      if (!currentNationalId) return;

      fingerprintMessage.className = 'alert mt-3 alert-info';
      fingerprintMessage.classList.remove('hidden');
      fingerprintMessageText.textContent = 'جاري محاكاة التحقق بالبصمة...';

      try {
        const res = await fetch('/api/verify-fingerprint', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nationalId: currentNationalId })
        });

        const data = await res.json();

        if (!data.ok) {
          fingerprintMessage.className = 'alert mt-3 alert-error';
          fingerprintMessageText.textContent = data.message || 'فشل التحقق بالبصمة.';
          return;
        }

        fillAppointment(data.appointment);
        setStep(3);
      } catch (err) {
        fingerprintMessage.className = 'alert mt-3 alert-error';
        fingerprintMessageText.textContent = 'حدث خطأ في الاتصال بالخادم.';
      }
    });

    function fillAppointment(ap) {
      apFullName.textContent = ap.fullName;
      apService.textContent = ap.service;
      apLocation.textContent = ap.location;
      apDate.textContent = ap.date;
      apTime.textContent = ap.time;
      apTicket.textContent = ap.ticketNumber;
      apNotes.textContent = ap.notes;
    }

    // New visitor (reset)
    btnNewVisitor.addEventListener('click', () => {
      currentNationalId = null;
      nationalIdInput.value = '';
      selfieSection.classList.add('hidden');
      fingerprintSection.classList.add('hidden');
      fingerprintMessage.classList.add('hidden');
      selfieMessage.classList.add('hidden');
      stopCamera();
      setStep(1);
    });

    // Start at step 1
    setStep(1);
  </script>
</body>
</html>
