<!-- public/index.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ø­Ø¬Ø² Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f7f8;
      color: #1f2933;
    }

    .app-header {
      background: linear-gradient(135deg, #0f7c4a, #0b5f39);
      color: #fff;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    .app-header .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-mark {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 2px solid #e2f7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 20px;
      background: rgba(0, 0, 0, 0.1);
    }

    .app-title-main {
      font-weight: 700;
      font-size: 18px;
    }

    .app-title-sub {
      font-size: 12px;
      opacity: 0.9;
    }

    .app-layout {
      max-width: 960px;
      margin: 32px auto;
      padding: 0 16px 32px;
    }

    .card {
      background: #ffffff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 16px rgba(15, 124, 74, 0.08);
      border-top: 4px solid #0f7c4a;
    }

    h1, h2, h3 {
      margin-top: 0;
      color: #123026;
    }

    .step-indicator {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      font-size: 13px;
      color: #4b5563;
      flex-wrap: wrap;
    }

    .step-pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: #e5f5ec;
      color: #0f7c4a;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .step-pill.inactive {
      background: #e5e7eb;
      color: #6b7280;
    }

    .step-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: currentColor;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      font-weight: 600;
    }

    input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #cbd5e1;
      font-size: 15px;
      box-sizing: border-box;
      direction: ltr;
      text-align: left;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #0f7c4a;
      box-shadow: 0 0 0 2px rgba(15, 124, 74, 0.2);
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }

    .btn-primary {
      background: #0f7c4a;
      color: #fff;
    }

    .btn-primary:hover {
      background: #0b5f39;
    }

    .btn-outline {
      background: #fff;
      border: 1px solid #0f7c4a;
      color: #0f7c4a;
    }

    .btn-outline:hover {
      background: #e5f5ec;
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }

    .btn-secondary:hover {
      background: #e5e7eb;
    }

    .mt-2 { margin-top: 8px; }
    .mt-3 { margin-top: 12px; }
    .mt-4 { margin-top: 16px; }
    .mt-5 { margin-top: 24px; }

    .alert {
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 13px;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-top: 12px;
    }

    .alert-info {
      background: #e0f2fe;
      color: #0369a1;
      border: 1px solid #7dd3fc;
    }

    .alert-error {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .alert-success {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .alert-icon {
      font-size: 16px;
      margin-top: 1px;
    }

    .hidden {
      display: none;
    }

    .verification-options {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 16px;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #e5f5ec;
      color: #0f7c4a;
      margin-right: 8px;
    }

    .camera-preview {
      margin-top: 16px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #d1d5db;
      max-width: 320px;
    }

    video {
      width: 100%;
      display: block;
    }

    .appointment-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px 24px;
      font-size: 14px;
      margin-top: 16px;
    }

    .appointment-label {
      font-weight: 600;
      color: #4b5563;
    }

    .appointment-value {
      color: #111827;
    }

    @media (max-width: 640px) {
      .appointment-grid {
        grid-template-columns: 1fr;
      }
    }

    .footer-note {
      margin-top: 16px;
      font-size: 11px;
      color: #6b7280;
      text-align: center;
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="logo">
      <div class="logo-mark">Ø¨</div>
      <div>
        <div class="app-title-main">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø°ÙƒÙŠØ©</div>
        <div class="app-title-sub">Ù…Ø­Ø§ÙƒØ§Ø© Ù†Ø¸Ø§Ù… Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¬Ù‡Ø§Øª Ø§Ù„Ø­ÙƒÙˆÙ…ÙŠØ©</div>
      </div>
    </div>
    <div style="font-size: 12px; opacity: 0.9;">
      Ù†Ø³Ø®Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© â€¢ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ‡Ù…ÙŠØ© Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·
    </div>
  </header>

  <main class="app-layout">
    <section class="card">
      <div class="step-indicator">
        <div class="step-pill" id="step-pill-1">
          <span class="step-dot"></span>
          Ù¡. Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©
        </div>
        <div class="step-pill inactive" id="step-pill-2">
          <span class="step-dot"></span>
          Ù¢. Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©
        </div>
        <div class="step-pill inactive" id="step-pill-3">
          <span class="step-dot"></span>
          Ù£. Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ¹Ø¯
        </div>
      </div>

      <!-- Step 1: Enter National ID -->
      <div id="step-1">
        <h2>Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆØ·Ù†ÙŠØ©</h2>
        <p style="font-size: 14px; color: #4b5563;">
          Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø­Ø¬Ø² Ù…Ø³Ø¨Ù‚ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….
        </p>

        <label for="nationalId">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆØ·Ù†ÙŠØ©</label>
        <input
          type="text"
          id="nationalId"
          maxlength="10"
          placeholder="Ù…Ø«Ø§Ù„: 1234567890"
        />

        <button class="btn btn-primary mt-3" id="btnCheckId">
          Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙˆØ¹Ø¯
        </button>

        <div class="alert alert-info mt-3">
          <span class="alert-icon">â„¹ï¸</span>
          <span>Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ØªØ³ØªØ®Ø¯Ù… Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ‡Ù…ÙŠØ© ÙˆÙ‡ÙŠ Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·ØŒ ÙˆÙ„Ø§ ØªØ±ØªØ¨Ø· Ø¨Ø£ÙŠ Ø£Ù†Ø¸Ù…Ø© Ø­ÙƒÙˆÙ…ÙŠØ© Ø­Ù‚ÙŠÙ‚ÙŠØ©.</span>
        </div>

        <div id="idError" class="alert alert-error mt-3 hidden">
          <span class="alert-icon">âš ï¸</span>
          <span id="idErrorMessage"></span>
        </div>
      </div>

      <!-- Step 2: Choose verification method -->
      <div id="step-2" class="hidden">
        <h2>Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ©</h2>
        <p style="font-size: 14px; color: #4b5563;">
          ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ© (Ø³ÙŠÙ„ÙÙŠ) Ø£Ùˆ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ØµÙ…Ø©.
        </p>

        <div class="verification-options">
          <button class="btn btn-outline" id="btnUseSelfie">
            ğŸ“· Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø§Ù„ØµÙˆØ±Ø© (Ø³ÙŠÙ„ÙÙŠ)
          </button>
          <button class="btn btn-outline" id="btnUseFingerprint">
            ğŸ– Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø§Ù„Ø¨ØµÙ…Ø©
          </button>
        </div>

        <!-- Selfie verification area -->
        <div id="selfieSection" class="hidden mt-4">
          <h3>
            Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø§Ù„ØµÙˆØ±Ø©
            <span class="badge">ØªØ¬Ø±ÙŠØ¨ÙŠ</span>
          </h3>
          <p style="font-size: 13px; color: #6b7280;">
            Ø³ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ø³Ø±ÙŠØ¹Ø©ØŒ Ø«Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØªØ­Ù‚Ù‚ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø®Ø§Ø¯Ù….
          </p>

          <div class="camera-preview">
            <video id="videoPreview" autoplay playsinline></video>
          </div>

          <button class="btn btn-primary mt-3" id="btnVerifySelfie">
            Ø§Ù„ØªÙ‚Ø§Ø· ÙˆØ§Ù„ØªØ­Ù‚Ù‚
          </button>

          <button class="btn btn-secondary mt-3" id="btnBackFromSelfie">
            Ø±Ø¬ÙˆØ¹ Ù„Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø£Ø®Ø±Ù‰
          </button>

          <div id="selfieMessage" class="alert mt-3 hidden">
            <span class="alert-icon">â„¹ï¸</span>
            <span id="selfieMessageText"></span>
          </div>
        </div>

        <!-- Fingerprint verification area -->
        <div id="fingerprintSection" class="hidden mt-4">
          <h3>
            Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø§Ù„Ø¨ØµÙ…Ø©
            <span class="badge">Ù…Ø­Ø§ÙƒØ§Ø©</span>
          </h3>
          <p style="font-size: 13px; color: #6b7280;">
            ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚Ø§Ø±Ø¦ Ø§Ù„Ø¨ØµÙ…Ø© Ø§Ù„Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø² Ù…Ø¹
            Ø¨Ø±Ù…Ø¬ÙŠØ§Øª Ù…ØªØ®ØµØµØ© Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø¨ØµÙ…Ø© Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            Ù†Ù‚ÙˆÙ… Ø¨Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙ‚Ø·.
          </p>

          <button class="btn btn-primary mt-3" id="btnSimulateFingerprint">
            Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø§Ù„Ø¨ØµÙ…Ø©
          </button>

          <button class="btn btn-secondary mt-3" id="btnBackFromFingerprint">
            Ø±Ø¬ÙˆØ¹ Ù„Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø£Ø®Ø±Ù‰
          </button>

          <div id="fingerprintMessage" class="alert mt-3 hidden">
            <span class="alert-icon">â„¹ï¸</span>
            <span id="fingerprintMessageText"></span>
          </div>
        </div>

        <button class="btn btn-secondary mt-4" id="btnBackToId">
          â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø®Ø·ÙˆØ© Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©
        </button>
      </div>

      <!-- Step 3: Appointment details -->
      <div id="step-3" class="hidden">
        <h2>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ¹Ø¯</h2>

        <div class="alert alert-success">
          <span class="alert-icon">âœ…</span>
          <span>ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡ÙˆÙŠØ© ØµØ§Ø­Ø¨ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­. ÙŠØ³Ù…Ø­ Ù„Ù‡ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„.</span>
        </div>

        <div class="appointment-grid">
          <div class="appointment-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</div>
          <div class="appointment-value" id="apFullName"></div>

          <div class="appointment-label">Ø§Ù„Ø®Ø¯Ù…Ø©</div>
          <div class="appointment-value" id="apService"></div>

          <div class="appointment-label">Ø§Ù„Ù…ÙˆÙ‚Ø¹</div>
          <div class="appointment-value" id="apLocation"></div>

          <div class="appointment-label">Ø§Ù„ØªØ§Ø±ÙŠØ®</div>
          <div class="appointment-value" id="apDate"></div>

          <div class="appointment-label">Ø§Ù„ÙˆÙ‚Øª</div>
          <div class="appointment-value" id="apTime"></div>

          <div class="appointment-label">Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø©</div>
          <div class="appointment-value" id="apTicket"></div>

          <div class="appointment-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
          <div class="appointment-value" id="apNotes"></div>
        </div>

        <button class="btn btn-primary mt-4" id="btnNewVisitor">
          Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø²Ø§Ø¦Ø± Ø§Ù„ØªØ§Ù„ÙŠ
        </button>

        <div class="footer-note">
          Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù„ØªØ¬Ø±Ø¨Ø© ÙÙ‚Ø· ÙˆÙ„Ø§ ÙŠÙ…Ø«Ù„ Ø£ÙŠ Ù…Ù†ØµØ© Ø±Ø³Ù…ÙŠØ©.
        </div>
      </div>
    </section>
  </main>

  <script>
    const step1 = document.getElementById('step-1');
    const step2 = document.getElementById('step-2');
    const step3 = document.getElementById('step-3');

    const pill1 = document.getElementById('step-pill-1');
    const pill2 = document.getElementById('step-pill-2');
    const pill3 = document.getElementById('step-pill-3');

    const nationalIdInput = document.getElementById('nationalId');
    const btnCheckId = document.getElementById('btnCheckId');
    const idError = document.getElementById('idError');
    const idErrorMessage = document.getElementById('idErrorMessage');

    const btnUseSelfie = document.getElementById('btnUseSelfie');
    const btnUseFingerprint = document.getElementById('btnUseFingerprint');
    const btnBackToId = document.getElementById('btnBackToId');

    const selfieSection = document.getElementById('selfieSection');
    const fingerprintSection = document.getElementById('fingerprintSection');

    const videoPreview = document.getElementById('videoPreview');
    const btnVerifySelfie = document.getElementById('btnVerifySelfie');
    const btnBackFromSelfie = document.getElementById('btnBackFromSelfie');
    const selfieMessage = document.getElementById('selfieMessage');
    const selfieMessageText = document.getElementById('selfieMessageText');

    const btnSimulateFingerprint = document.getElementById('btnSimulateFingerprint');
    const btnBackFromFingerprint = document.getElementById('btnBackFromFingerprint');
    const fingerprintMessage = document.getElementById('fingerprintMessage');
    const fingerprintMessageText = document.getElementById('fingerprintMessageText');

    const apFullName = document.getElementById('apFullName');
    const apService = document.getElementById('apService');
    const apLocation = document.getElementById('apLocation');
    const apDate = document.getElementById('apDate');
    const apTime = document.getElementById('apTime');
    const apTicket = document.getElementById('apTicket');
    const apNotes = document.getElementById('apNotes');

    const btnNewVisitor = document.getElementById('btnNewVisitor');

    let currentNationalId = null;
    let currentStream = null;

    function setStep(stepNumber) {
      step1.classList.add('hidden');
      step2.classList.add('hidden');
      step3.classList.add('hidden');

      pill1.classList.add('inactive');
      pill2.classList.add('inactive');
      pill3.classList.add('inactive');

      if (stepNumber === 1) {
        step1.classList.remove('hidden');
        pill1.classList.remove('inactive');
      } else if (stepNumber === 2) {
        step2.classList.remove('hidden');
        pill2.classList.remove('inactive');
      } else if (stepNumber === 3) {
        step3.classList.remove('hidden');
        pill3.classList.remove('inactive');
      }
    }

    // Stop camera stream if running
    function stopCamera() {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
      }
    }

    // Step 1: Check ID
    btnCheckId.addEventListener('click', async () => {
      const id = nationalIdInput.value.trim();

      idError.classList.add('hidden');

      if (!id || id.length < 10) {
        idErrorMessage.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡ÙˆÙŠØ© ØµØ­ÙŠØ­ Ù…ÙƒÙˆÙ† Ù…Ù† 10 Ø£Ø±Ù‚Ø§Ù….';
        idError.classList.remove('hidden');
        return;
      }

      try {
        const res = await fetch('/api/check-id', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nationalId: id })
        });

        const data = await res.json();

        if (!data.ok) {
          idErrorMessage.textContent = data.message || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¹Ø¯ Ù…Ø³Ø¬Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù….';
          idError.classList.remove('hidden');
          return;
        }

        currentNationalId = id;
        setStep(2);
      } catch (err) {
        idErrorMessage.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
        idError.classList.remove('hidden');
      }
    });

    // Step 2: choose verification method
    btnUseSelfie.addEventListener('click', async () => {
      fingerprintSection.classList.add('hidden');
      selfieSection.classList.remove('hidden');
      selfieMessage.classList.add('hidden');

      // Start camera
      try {
        stopCamera();
        currentStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        videoPreview.srcObject = currentStream;
      } catch (err) {
        selfieMessage.classList.remove('hidden');
        selfieMessage.classList.add('alert-error');
        selfieMessageText.textContent = 'ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª.';
      }
    });

    btnBackFromSelfie.addEventListener('click', () => {
      selfieSection.classList.add('hidden');
      stopCamera();
    });

    btnUseFingerprint.addEventListener('click', () => {
      selfieSection.classList.add('hidden');
      stopCamera();
      fingerprintSection.classList.remove('hidden');
      fingerprintMessage.classList.add('hidden');
    });

    btnBackFromFingerprint.addEventListener('click', () => {
      fingerprintSection.classList.add('hidden');
    });

    btnBackToId.addEventListener('click', () => {
      selfieSection.classList.add('hidden');
      fingerprintSection.classList.add('hidden');
      stopCamera();
      setStep(1);
    });

    // Selfie verification (simulated)
    btnVerifySelfie.addEventListener('click', async () => {
      if (!currentNationalId) return;

      selfieMessage.className = 'alert mt-3';
      selfieMessage.classList.add('alert-info');
      selfieMessage.classList.remove('hidden');
      selfieMessageText.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ­Ù‚Ù‚...';

      // In a real system, you'd capture a frame from the video and send it.
      try {
        const res = await fetch('/api/verify-selfie', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nationalId: currentNationalId })
        });

        const data = await res.json();

        if (!data.ok) {
          selfieMessage.className = 'alert mt-3 alert-error';
          selfieMessageText.textContent = data.message || 'ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø§Ù„ØµÙˆØ±Ø©.';
          return;
        }

        // Success -> show appointment
        fillAppointment(data.appointment);
        stopCamera();
        setStep(3);
      } catch (err) {
        selfieMessage.className = 'alert mt-3 alert-error';
        selfieMessageText.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….';
      }
    });

    // Fingerprint verification (simulated)
    btnSimulateFingerprint.addEventListener('click', async () => {
      if (!currentNationalId) return;

      fingerprintMessage.className = 'alert mt-3 alert-info';
      fingerprintMessage.classList.remove('hidden');
      fingerprintMessageText.textContent = 'Ø¬Ø§Ø±ÙŠ Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø§Ù„Ø¨ØµÙ…Ø©...';

      try {
        const res = await fetch('/api/verify-fingerprint', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nationalId: currentNationalId })
        });

        const data = await res.json();

        if (!data.ok) {
          fingerprintMessage.className = 'alert mt-3 alert-error';
          fingerprintMessageText.textContent = data.message || 'ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø§Ù„Ø¨ØµÙ…Ø©.';
          return;
        }

        fillAppointment(data.appointment);
        setStep(3);
      } catch (err) {
        fingerprintMessage.className = 'alert mt-3 alert-error';
        fingerprintMessageText.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….';
      }
    });

    function fillAppointment(ap) {
      apFullName.textContent = ap.fullName;
      apService.textContent = ap.service;
      apLocation.textContent = ap.location;
      apDate.textContent = ap.date;
      apTime.textContent = ap.time;
      apTicket.textContent = ap.ticketNumber;
      apNotes.textContent = ap.notes;
    }

    // New visitor (reset)
    btnNewVisitor.addEventListener('click', () => {
      currentNationalId = null;
      nationalIdInput.value = '';
      selfieSection.classList.add('hidden');
      fingerprintSection.classList.add('hidden');
      fingerprintMessage.classList.add('hidden');
      selfieMessage.classList.add('hidden');
      stopCamera();
      setStep(1);
    });

    // Start at step 1
    setStep(1);
  </script>
</body>
</html>
