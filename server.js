// server.js
const  express = require('express');
const path = require('path');
const fs = require('fs');
const multer = require('multer');
const { exec } = require('child_process');
const { promisify } = require('util');

const execAsync = promisify(exec);

const app = express();
const PORT = 3000;

// Configure multer for file uploads (memory storage)
const upload = multer({
  storage: multer.memoryStorage(),
  limits: { fileSize: 10 * 1024 * 1024 } // 10MB
});

// Ensure uploads directory exists for temp files
const uploadsDir = path.join(__dirname, 'uploads');
if (!fs.existsSync(uploadsDir)) {
  fs.mkdirSync(uploadsDir, { recursive: true });
}

// Middleware
app.use(express.json());
app.use(express.static(path.join(__dirname, 'public')));

// ---- Mock "database" of appointments ----
const appointments = [
  {
    nationalId: '1234567890',
    embedding:[
    -0.7724648118019104,
    -0.09659139811992645,
    -1.6844021081924438,
    -1.8104078769683838,
    -0.7237635850906372,
    1.644655466079712,
    -1.6561923027038574,
    3.3712265491485596,
    -1.17172110080719,
    -2.6225991249084473,
    0.5803972482681274,
    1.0242351293563843,
    -1.0741945505142212,
    -2.1513030529022217,
    -0.663541316986084,
    -1.836398720741272,
    -2.780388832092285,
    0.1993551105260849,
    -1.4461091756820679,
    -0.478688508272171,
    -5.0230937004089355,
    0.4202154278755188,
    2.741931438446045,
    1.7926642894744873,
    0.9112747311592102,
    1.9077205657958984,
    -1.1770210266113281,
    0.6348897218704224,
    1.033761739730835,
    -0.5373090505599976,
    2.1310875415802,
    -0.40029507875442505,
    -0.7360360622406006,
    -2.324462890625,
    1.5885142087936401,
    -0.7376319766044617,
    -2.7728307247161865,
    0.7384955286979675,
    0.36220604181289673,
    -1.7733063697814941,
    -1.122789978981018,
    -0.7921590805053711,
    -0.004401323385536671,
    0.08887861669063568,
    -1.7949494123458862,
    -1.3756316900253296,
    0.6109135746955872,
    0.14461088180541992,
    1.811032772064209,
    0.1865691989660263,
    2.729257345199585,
    -3.8800365924835205,
    -0.45400840044021606,
    -3.444594383239746,
    0.6669823527336121,
    1.3895784616470337,
    1.6905968189239502,
    0.644984781742096,
    2.7053382396698,
    0.09994550794363022,
    1.396438479423523,
    0.3426392674446106,
    -0.2505775988101959,
    -0.07358605414628983,
    0.6137086153030396,
    -0.23187443614006042,
    1.2426202297210693,
    2.1512396335601807,
    -2.061962127685547,
    0.2316131293773651,
    -2.1512060165405273,
    -1.281930923461914,
    -1.2978898286819458,
    0.8013411164283752,
    0.232312873005867,
    -2.939568281173706,
    -2.2504260540008545,
    1.2026314735412598,
    -0.8529607653617859,
    1.3378279209136963,
    -1.2251598834991455,
    -1.7632510662078857,
    0.9243711233139038,
    0.400911420583725,
    -0.24285082519054413,
    1.2648591995239258,
    -2.19937801361084,
    -1.6708029508590698,
    -0.4708302319049835,
    2.194467544555664,
    -1.9349480867385864,
    -0.2791445851325989,
    -0.05197189003229141,
    -0.4020065665245056,
    -0.9058974981307983,
    -0.3026687204837799,
    1.5676887035369873,
    -1.6718169450759888,
    2.408034324645996,
    -2.003124713897705,
    -0.5384435653686523,
    -1.5409491062164307,
    -0.6893179416656494,
    -0.8827778100967407,
    1.9089604616165161,
    0.9986277222633362,
    1.2888633012771606,
    0.8784864544868469,
    -0.7338952422142029,
    -2.2406601905822754,
    1.1364303827285767,
    -0.8718928098678589,
    -0.6619119048118591,
    1.155647873878479,
    3.7553279399871826,
    -0.0801151767373085,
    0.8417268395423889,
    0.25198742747306824,
    -1.6838836669921875,
    2.4571239948272705,
    -1.215737223625183,
    0.31922104954719543,
    -0.11663398146629333,
    1.615395188331604,
    0.8908272981643677,
    1.9068690538406372,
    0.9198738932609558,
    -0.8348462581634521,
    -1.9296386241912842,
    -0.6907259821891785,
    -1.1556200981140137,
    -0.06861013919115067,
    1.9204964637756348,
    3.5477449893951416,
    -0.12389300018548965,
    -0.03454836085438728,
    4.472184181213379,
    1.6721889972686768,
    -3.241544008255005,
    1.4984991550445557,
    1.579368233680725,
    -1.6376370191574097,
    2.680116891860962,
    -1.635827660560608,
    0.8818563222885132,
    0.2774185836315155,
    1.897925853729248,
    1.7229517698287964,
    0.8305863738059998,
    2.471327066421509,
    -1.6245087385177612,
    -0.8546550273895264,
    -1.7940467596054077,
    2.1501307487487793,
    0.6453279256820679,
    -1.7009930610656738,
    -2.642463445663452,
    0.748250424861908,
    -0.6919374465942383,
    0.3777621388435364,
    -1.22947096824646,
    1.8500473499298096,
    1.937262773513794,
    0.5151673555374146,
    -2.1125922203063965,
    -2.662027597427368,
    0.7692621946334839,
    -0.5461077094078064,
    1.3726791143417358,
    0.9425757527351379,
    0.7592983245849609,
    -0.12950843572616577,
    -0.48173782229423523,
    3.511617422103882,
    -2.4871938228607178,
    -0.25088217854499817,
    0.9762169718742371,
    0.8514187335968018,
    -1.4314583539962769,
    1.4464393854141235,
    -0.8619641661643982,
    1.7009855508804321,
    0.1544310748577118,
    1.4055155515670776,
    -0.03194049000740051,
    0.9077117443084717,
    -1.0895076990127563,
    -0.48941102623939514,
    -1.616725206375122,
    4.236419677734375,
    -2.2971606254577637,
    -1.562738060951233,
    0.28630998730659485,
    -1.616710901260376,
    -0.11289200186729431,
    -0.9122065901756287,
    0.19646066427230835,
    1.7536547183990479,
    0.606844425201416,
    -1.005745530128479,
    0.017285101115703583,
    0.6166834831237793,
    0.42772355675697327,
    -1.2998764514923096,
    -2.682420015335083,
    -0.6467463374137878,
    -2.581416606903076,
    -0.13556510210037231,
    0.03839266300201416,
    -0.7501306533813477,
    0.07472728192806244,
    -3.4418656826019287,
    1.0175331830978394,
    -0.430231511592865,
    -1.1234915256500244,
    -0.8465143442153931,
    -0.15885034203529358,
    0.45377302169799805,
    -0.415082722902298,
    -0.875831663608551,
    0.15656407177448273,
    2.2452187538146973,
    1.3464018106460571,
    2.4234678745269775,
    1.1272573471069336,
    2.580808162689209,
    0.4452965557575226,
    0.7329294085502625,
    1.5941455364227295,
    1.1783775091171265,
    0.5924392938613892,
    1.1815119981765747,
    -2.304438352584839,
    1.3798363208770752,
    3.461531400680542,
    -0.545825183391571,
    1.0980803966522217,
    -2.800647020339966,
    -1.5195368528366089,
    1.4824868440628052,
    -1.6743106842041016,
    -1.308304786682129,
    0.004695420153439045,
    -2.861387014389038,
    -1.8281121253967285,
    3.4014580249786377,
    0.524242639541626,
    0.18082304298877716,
    0.6993761658668518,
    -0.6589722633361816,
    1.3530960083007812,
    -2.430967092514038,
    3.6623599529266357,
    -1.5698689222335815,
    1.9651448726654053,
    0.04613800719380379,
    -0.14078819751739502,
    0.16122682392597198,
    1.8464752435684204,
    0.8366919159889221,
    -0.20763875544071198,
    1.0087534189224243,
    0.7392066717147827,
    0.048695262521505356,
    2.2776854038238525,
    2.4106953144073486,
    0.48730480670928955,
    -2.1886229515075684,
    -0.5756852030754089,
    -0.1381678730249405,
    -1.0583096742630005,
    0.2547582983970642,
    0.12375493347644806,
    2.084374189376831,
    -1.4757978916168213,
    -1.2273046970367432,
    0.04319864511489868,
    -1.7436048984527588,
    -0.023594362661242485,
    0.45448699593544006,
    0.9692338109016418,
    0.27757906913757324,
    2.4355809688568115,
    -1.6923097372055054,
    2.4903390407562256,
    1.9220777750015259,
    -0.45113885402679443,
    1.943803310394287,
    -1.4665340185165405,
    2.2615344524383545,
    0.3661346137523651,
    -0.47193530201911926,
    0.06196073442697525,
    -0.7591408491134644,
    1.2104276418685913,
    1.6288237571716309,
    1.4156935214996338,
    1.0546070337295532,
    -1.3274831771850586,
    1.4298826456069946,
    -3.3011810779571533,
    1.7222498655319214,
    -0.3865925371646881,
    0.4368865489959717,
    -0.6122827529907227,
    2.216691732406616,
    -1.5377105474472046,
    2.9725329875946045,
    0.8086273074150085,
    -0.9056867957115173,
    -1.9263092279434204,
    -0.004881471395492554,
    1.5309500694274902,
    2.9877915382385254,
    -0.7854057550430298,
    -1.3934059143066406,
    -0.5960090160369873,
    2.9168004989624023,
    -0.05806504562497139,
    -1.0479910373687744,
    1.900311827659607,
    -1.0156737565994263,
    -1.4874706268310547,
    -0.0208442285656929,
    1.9692578315734863,
    3.0842108726501465,
    -0.4564126133918762,
    -0.6699756383895874,
    -0.6566793322563171,
    3.0497007369995117,
    1.2278828620910645,
    0.7357838153839111,
    0.9740731120109558,
    -0.5721918940544128,
    0.48072880506515503,
    -1.9204800128936768,
    0.21610523760318756,
    -2.111590623855591,
    0.015228962525725365,
    2.3857555389404297,
    0.7770943641662598,
    0.617436945438385,
    -0.04267005994915962,
    -0.2369488626718521,
    -0.029595591127872467,
    -0.0442480631172657,
    2.035041332244873,
    -1.3423635959625244,
    -1.2041643857955933,
    -0.22860173881053925,
    0.9944803714752197,
    0.4763280749320984,
    -0.825253963470459,
    1.7599369287490845,
    -1.8882055282592773,
    -1.7163379192352295,
    -1.3620918989181519,
    -0.35813605785369873,
    -1.8554826974868774,
    2.154832124710083,
    -0.7888703346252441,
    3.6731176376342773,
    -0.439299613237381,
    1.7735642194747925,
    1.7980074882507324,
    2.316891670227051,
    6.140549659729004,
    -1.2294656038284302,
    -0.5639126896858215,
    1.5972307920455933,
    0.18284925818443298,
    -1.1857432126998901,
    2.403160572052002,
    -1.378443717956543,
    0.6067083477973938,
    3.279167413711548,
    -2.173038959503174,
    0.6890465021133423,
    1.6207234859466553,
    -1.3256474733352661,
    0.17688791453838348,
    -0.30011042952537537,
    -0.5122895240783691,
    2.0439820289611816,
    -2.1045587062835693,
    -1.4342973232269287,
    0.006195442751049995,
    1.1325795650482178,
    -2.500732421875,
    1.3241530656814575,
    -0.27815428376197815,
    2.3615474700927734,
    -0.2762272357940674,
    0.988002598285675,
    -0.25166550278663635,
    1.1303761005401611,
    -2.1146621704101562,
    0.9652389883995056,
    -0.8552384376525879,
    -0.9734947681427002,
    -3.0254244804382324,
    -0.9167287945747375,
    1.7365565299987793,
    0.16460593044757843,
    0.7246468663215637,
    0.9321616888046265,
    -1.1650809049606323,
    -1.2010091543197632,
    1.3928903341293335,
    1.6963019371032715,
    -2.0439350605010986,
    0.27902674674987793,
    -3.2067372798919678,
    -3.048022508621216,
    1.864706039428711,
    -0.5513906478881836,
    0.6629837155342102,
    -3.5000782012939453,
    0.29591670632362366,
    2.3874194622039795,
    -1.6355640888214111,
    -0.47631922364234924,
    0.8055166006088257,
    -3.6896276473999023,
    0.18736977875232697,
    1.6667836904525757,
    -1.9291400909423828,
    -3.152069330215454,
    -1.2171672582626343,
    -0.9570563435554504,
    -1.7077921628952026,
    0.757317304611206,
    0.3479674756526947,
    -1.3016297817230225,
    -1.4999041557312012,
    0.32807379961013794,
    -1.0572352409362793,
    0.41474610567092896,
    -0.8195558786392212,
    -2.768148183822632,
    0.9552253484725952,
    0.47276771068573,
    -0.3556305170059204,
    -0.13486076891422272,
    -1.080754280090332,
    0.3077804446220398,
    0.8440722227096558,
    -0.48658356070518494,
    2.5030133724212646,
    2.0868289470672607,
    1.9222049713134766,
    -1.2769137620925903,
    -0.03676743060350418,
    0.8255815505981445,
    0.10078610479831696,
    -1.3259063959121704,
    -1.9561553001403809,
    -1.9246281385421753,
    0.07932347804307938,
    2.133162260055542,
    -1.3928722143173218,
    2.1784000396728516,
    -2.668184995651245,
    -0.05003052204847336,
    1.3272340297698975,
    -0.36045634746551514,
    0.9897304177284241,
    -1.5742850303649902,
    0.1530921459197998,
    -0.020315224304795265,
    -2.147392749786377,
    1.8163361549377441,
    -1.2748578786849976,
    0.6308271884918213,
    -1.142056941986084,
    0.1259894073009491,
    2.1364738941192627,
    0.3987888693809509,
    1.3007855415344238,
    -1.731967806816101,
    0.22313040494918823,
    -1.3205748796463013,
    -1.2912883758544922,
    1.2112548351287842,
    0.25764188170433044,
    -0.0952795073390007,
    -1.328287959098816,
    -1.4988476037979126,
    0.6268817186355591,
    -2.260085105895996,
    -0.7622311115264893,
    -2.882126569747925,
    -3.0651679039001465,
    -0.5002526640892029,
    -0.6726423501968384,
    -2.7323153018951416,
    0.487134724855423,
    -0.25743934512138367,
    -1.6447750329971313,
    -0.7064736485481262,
    -2.126255512237549,
    -2.3099844455718994,
    0.9164412021636963,
    2.2242166996002197,
    2.9113566875457764,
    0.5818384885787964,
    0.10258668661117554,
    -1.7360203266143799,
    2.751044511795044,
    1.3119958639144897,
    0.3248533010482788,
    -2.9618818759918213
  ],
    fullName: 'ياسر العصيمي',
    service: 'الأحوال المدنية - تجديد بطاقة الهوية الوطنية',
    location: 'مكتب الأحوال المدنية بالرياض - فرع العليا',
    date: '2025-12-05',
    time: '10:30 ص',
    ticketNumber: 'أ-102',
    notes: 'يُرجى التوجه إلى الطابق الأول عبر المصعد الرئيسي أو الدرج المجاور للاستقبال. تقع النافذة رقم 5 في القسم الأيمن من الصالة، بجانب لوحة الإرشادات الإلكترونية. سيتم عرض رقم تذكرتكم أ-102 على الشاشة الإلكترونية عند حلول دوركم.'
  },
  {
     nationalId: '1111222233',
     embedding: [
      0.4244726896286011,
      0.6870794296264648,
      2.386183738708496,
      1.7698140144348145,
      -2.0082924365997314,
      1.4200034141540527,
      1.725021481513977,
      -0.6468028426170349,
      -2.4680752754211426,
      -0.503379225730896,
      3.132995367050171,
      1.4128385782241821,
      -0.1192612573504448,
      1.7951712608337402,
      1.4446810483932495,
      -2.159663438796997,
      -0.9948842525482178,
      -0.8718708157539368,
      0.7257795929908752,
      0.5279687643051147,
      -0.4967004358768463,
      -0.3024838864803314,
      -0.6164353489875793,
      0.48260998725891113,
      2.6201913356781006,
      -0.1767462193965912,
      -0.38418835401535034,
      0.20381487905979156,
      1.6673219203948975,
      -1.9574151039123535,
      3.27298903465271,
      -0.8639438152313232,
      0.5395623445510864,
      -2.0977394580841064,
      -2.626190185546875,
      -0.9161550402641296,
      -0.25919830799102783,
      -0.4602816104888916,
      0.33839988708496094,
      -0.4310905337333679,
      -2.3866312503814697,
      1.136391043663025,
      0.30785658955574036,
      1.6446826457977295,
      2.930549144744873,
      -1.093747615814209,
      0.8611753582954407,
      0.35923129320144653,
      -1.2428241968154907,
      -1.9136501550674438,
      -1.865336298942566,
      0.5828380584716797,
      0.6717343926429749,
      -1.149552583694458,
      1.1362481117248535,
      0.07418929040431976,
      2.7157773971557617,
      2.2874882221221924,
      3.3747594356536865,
      -1.2979072332382202,
      0.9360414147377014,
      -1.0889413356781006,
      -0.33269184827804565,
      2.505600690841675,
      -1.7556449174880981,
      -2.2481391429901123,
      1.3770551681518555,
      0.29023948311805725,
      0.17733606696128845,
      1.5807663202285767,
      -0.15839777886867523,
      -1.2433457374572754,
      -1.210327386856079,
      2.26711368560791,
      0.10082678496837616,
      0.5780879855155945,
      0.05781266838312149,
      0.6714608073234558,
      -1.3440877199172974,
      -0.024560358375310898,
      2.319793939590454,
      -1.07021963596344,
      2.876375675201416,
      -1.1727796792984009,
      0.029582450166344643,
      1.4779232740402222,
      0.2435413897037506,
      -0.11319844424724579,
      1.0448932647705078,
      0.8674660921096802,
      1.3624591827392578,
      2.1884286403656006,
      -1.174055814743042,
      -2.0448317527770996,
      -1.0302698612213135,
      -0.3161170482635498,
      1.4018815755844116,
      0.2548620402812958,
      -0.11661100387573242,
      0.023936765268445015,
      -0.018333055078983307,
      -0.3655901551246643,
      -1.070430040359497,
      0.7549843788146973,
      1.8809683322906494,
      -2.522996187210083,
      0.7169259190559387,
      -1.1082569360733032,
      1.6714667081832886,
      1.688819408416748,
      -0.6526330709457397,
      -0.2587265372276306,
      -1.3450156450271606,
      0.7093210220336914,
      -0.5886211395263672,
      -0.9522444009780884,
      1.811894178390503,
      -0.38940900564193726,
      -0.13737954199314117,
      2.5347700119018555,
      1.8455479145050049,
      -1.2291533946990967,
      1.2273162603378296,
      0.9959284663200378,
      -0.7316503524780273,
      0.253136545419693,
      2.280236005783081,
      -0.2224416732788086,
      -0.29814890027046204,
      0.8104801177978516,
      1.1717346906661987,
      -0.048713915050029755,
      -2.2041871547698975,
      -0.7472025156021118,
      -1.3640666007995605,
      1.1583218574523926,
      -1.025770664215088,
      1.0898107290267944,
      1.3518229722976685,
      0.7553688883781433,
      -0.6266078948974609,
      -2.089829206466675,
      1.1247010231018066,
      1.5154919624328613,
      0.18755680322647095,
      0.23925724625587463,
      1.614577293395996,
      0.7462665438652039,
      -0.7015444040298462,
      -0.31972187757492065,
      -1.796785593032837,
      -1.2222957611083984,
      -0.003097160719335079,
      -1.425756812095642,
      1.6407667398452759,
      1.07816743850708,
      -0.7652708292007446,
      -0.11465851962566376,
      0.515267014503479,
      1.419346570968628,
      0.8836798667907715,
      -1.7112499475479126,
      -2.7895407676696777,
      -2.0185952186584473,
      0.09698764234781265,
      -1.3121256828308105,
      1.4114216566085815,
      2.6845297813415527,
      -2.6419003009796143,
      1.8745763301849365,
      3.231158494949341,
      -2.2078328132629395,
      -0.27315235137939453,
      -2.7194759845733643,
      1.1077088117599487,
      0.04630662500858307,
      1.1296486854553223,
      0.08922862261533737,
      3.757345676422119,
      -0.543884813785553,
      -0.4682193994522095,
      2.371725559234619,
      1.2599573135375977,
      -2.172642230987549,
      0.8420256972312927,
      0.8089736104011536,
      1.3511979579925537,
      -0.4576394557952881,
      -2.0036978721618652,
      -1.3112555742263794,
      -0.5062068700790405,
      0.46875128149986267,
      3.0322256088256836,
      -2.83876371383667,
      0.23688840866088867,
      -0.029430629685521126,
      0.12831147015094757,
      0.6066479682922363,
      -1.229727029800415,
      -1.2442375421524048,
      -0.138249009847641,
      2.7175145149230957,
      0.4835447072982788,
      -1.7447538375854492,
      -2.2531750202178955,
      0.06004024296998978,
      -0.23119691014289856,
      0.913672685623169,
      -0.4492289125919342,
      -1.4679179191589355,
      0.6033049821853638,
      -3.0221571922302246,
      0.5985666513442993,
      0.8327568173408508,
      -2.453986406326294,
      0.5168377161026001,
      -1.1080728769302368,
      -4.918954372406006,
      0.9008515477180481,
      -0.19746464490890503,
      -1.9698913097381592,
      -0.5573421716690063,
      -0.4269541800022125,
      0.06029790639877319,
      -0.23114879429340363,
      -0.39320623874664307,
      -2.713724374771118,
      0.24944916367530823,
      -3.274599075317383,
      -1.673174500465393,
      0.43195804953575134,
      0.006515628658235073,
      -3.913191318511963,
      0.10067499428987503,
      -1.8532894849777222,
      -1.0233246088027954,
      0.8591750264167786,
      -1.901391625404358,
      -0.5597506165504456,
      1.1129230260849,
      -1.1036115884780884,
      1.6381521224975586,
      0.9360811114311218,
      -1.2825769186019897,
      3.0371479988098145,
      0.28410428762435913,
      -0.2625236511230469,
      2.617955446243286,
      -1.8707908391952515,
      -3.9948976039886475,
      1.2078616619110107,
      1.2849810123443604,
      0.06113065406680107,
      -2.514775276184082,
      0.8242364525794983,
      1.127299189567566,
      2.3046560287475586,
      1.774900197982788,
      0.957611083984375,
      0.5282788276672363,
      -1.7237237691879272,
      2.3248181343078613,
      -1.951789379119873,
      1.6556494235992432,
      0.9022004008293152,
      1.8426024913787842,
      -0.11458157002925873,
      1.6680828332901,
      -1.1891942024230957,
      0.3939533829689026,
      -1.5970820188522339,
      0.9509485960006714,
      -0.04625612124800682,
      -1.4295034408569336,
      -1.1844600439071655,
      -0.7424598336219788,
      -1.1472752094268799,
      0.1805250197649002,
      0.8882651925086975,
      1.6443556547164917,
      -0.40687331557273865,
      -0.7621142864227295,
      -0.9553838968276978,
      -3.0912222862243652,
      -1.2353609800338745,
      0.6226406693458557,
      -2.4009792804718018,
      2.2942287921905518,
      1.8804396390914917,
      -0.15825112164020538,
      1.9723033905029297,
      0.9196736216545105,
      1.7196351289749146,
      -2.0479023456573486,
      0.6720612645149231,
      2.154271125793457,
      1.6897633075714111,
      -0.2577475607395172,
      -2.0040106773376465,
      2.042689323425293,
      -3.9867258071899414,
      0.3600655496120453,
      -0.1472170054912567,
      2.9278981685638428,
      0.4160598814487457,
      0.8196586966514587,
      -1.3571521043777466,
      -1.4340455532073975,
      0.34792959690093994,
      -0.5184588432312012,
      -2.0554068088531494,
      -1.7106573581695557,
      -1.0201395750045776,
      -1.7051981687545776,
      -0.04281928762793541,
      -1.576019525527954,
      2.2453222274780273,
      2.773618459701538,
      -0.5250284671783447,
      2.5516560077667236,
      0.7847370505332947,
      -1.3641364574432373,
      -0.28152450919151306,
      -1.8184789419174194,
      2.448168992996216,
      0.8159740567207336,
      -0.9850262403488159,
      -0.32770052552223206,
      0.4480362832546234,
      0.9710419774055481,
      0.735698401927948,
      -0.8138587474822998,
      0.19391211867332458,
      -3.523935317993164,
      -1.430448293685913,
      -0.4899604022502899,
      -0.8306028842926025,
      -2.555236577987671,
      -0.49877357482910156,
      0.502723753452301,
      1.6766769886016846,
      0.6340802907943726,
      4.1643900871276855,
      0.1180238425731659,
      -0.07672036439180374,
      -2.1127066612243652,
      2.8161051273345947,
      1.8019574880599976,
      0.1541656106710434,
      -0.755338191986084,
      0.40594691038131714,
      -1.1915196180343628,
      -0.7645655274391174,
      0.4141862094402313,
      -1.5596380233764648,
      0.1531534343957901,
      0.6448928713798523,
      0.9128534197807312,
      -0.7141519784927368,
      -1.345386266708374,
      -1.2056957483291626,
      0.6832118630409241,
      0.32440319657325745,
      2.946234941482544,
      -0.7928057312965393,
      2.6444380283355713,
      -0.5088234543800354,
      0.8541918396949768,
      -2.2494752407073975,
      0.745163083076477,
      -0.6068906188011169,
      0.21509581804275513,
      3.2749228477478027,
      -0.6633327603340149,
      0.059358879923820496,
      -0.06682801991701126,
      0.5276756882667542,
      0.8347830772399902,
      1.4743753671646118,
      1.5785654783248901,
      -1.8938199281692505,
      1.6015512943267822,
      0.3618115782737732,
      -1.0782486200332642,
      0.6727619767189026,
      -1.1337395906448364,
      -1.5442306995391846,
      0.49346786737442017,
      -1.0391709804534912,
      -0.6179463863372803,
      1.2606362104415894,
      1.8822405338287354,
      -0.8763505220413208,
      -1.8289023637771606,
      0.11850342154502869,
      0.308250367641449,
      -1.8681055307388306,
      1.6082179546356201,
      -1.9099260568618774,
      0.4807831048965454,
      -1.309952974319458,
      -1.1000674962997437,
      0.5185374617576599,
      1.1995811462402344,
      -3.400524854660034,
      2.087789535522461,
      1.5433579683303833,
      2.172240972518921,
      2.1935055255889893,
      -0.3295627236366272,
      -0.2472035139799118,
      -1.132546305656433,
      0.4471851885318756,
      -1.2032912969589233,
      0.031984396278858185,
      -0.8729886412620544,
      0.10965842008590698,
      -3.1307148933410645,
      0.7212077379226685,
      -0.8670401573181152,
      0.6586253643035889,
      -3.776811361312866,
      1.6790900230407715,
      -0.7472561597824097,
      3.454357862472534,
      4.027555465698242,
      -1.5484681129455566,
      -0.5845534801483154,
      0.5231425166130066,
      1.3272465467453003,
      0.2683706283569336,
      -1.3494561910629272,
      0.6502751111984253,
      -0.23415698111057281,
      -1.38947594165802,
      -1.058921456336975,
      -0.04957227408885956,
      -0.6828348636627197,
      -0.971107006072998,
      0.5912537574768066,
      -2.1244986057281494,
      -0.18586309254169464,
      1.595139741897583,
      -0.24741585552692413,
      -1.5261316299438477,
      0.5721160769462585,
      -3.1820218563079834,
      -0.6213247179985046,
      -0.2109937071800232,
      -0.14159968495368958,
      0.631413996219635,
      0.6400477290153503,
      2.1242451667785645,
      -0.7490444183349609,
      -0.770462155342102,
      -0.048401448875665665,
      0.3374054431915283,
      1.3708332777023315,
      1.8897680044174194,
      -0.9879343509674072,
      -0.5576462149620056,
      0.7968571186065674,
      -0.11121376603841782,
      0.06531549990177155,
      -2.4851126670837402,
      0.687749445438385,
      1.7497479915618896,
      1.9359958171844482,
      -0.14626941084861755,
      -0.8877898454666138,
      1.013649344444275,
      -0.88559889793396,
      -1.4089397192001343,
      -0.21487648785114288,
      1.6705656051635742,
      -3.3236935138702393,
      2.3029556274414062,
      -0.14566156268119812,
      1.097773551940918,
      -1.252329707145691,
      -1.0061837434768677,
      1.5520364046096802,
      -2.08070969581604,
      1.6680644750595093,
      -1.191866397857666,
      -0.6044922471046448,
      -0.6507831811904907,
      -1.0726503133773804,
      -0.08301232755184174,
      2.0392603874206543,
      -2.058305025100708,
      -1.2940351963043213,
      0.8406647443771362,
      -0.11487160623073578,
      0.9284679889678955,
      0.2101239264011383,
      -1.9670261144638062,
      1.0852322578430176,
      0.18478073179721832,
      -1.2378815412521362,
      -0.7742537260055542,
      -0.13274280726909637,
      -2.3541104793548584,
      -1.5432395935058594,
      -1.5325660705566406,
      -0.45821651816368103,
      1.5738445520401,
      1.018436074256897,
      2.866915464401245,
      -0.1472928822040558,
      -0.6944682002067566,
      -0.13354982435703278
    ],
    fullName: 'عبدالله السواحه', // for face recognition, it will be used to compare the face with the embedding
    service: 'مكتب الجوازات - إصدار جواز سفر',
    location: 'مكتب الجوازات بالرياض - طريق الملك فهد',
    date: '2025-12-06',
    time: '01:15 م',
    ticketNumber: 'ب-057',
    notes: 'تقع النافذة رقم 12 في الصالة الرئيسية بالطابق الأرضي، على بُعد عشرة أمتار تقريباً من المدخل الرئيسي جهة اليسار. يُمكن الوصول إليها مباشرة بعد تجاوز بوابة الأمن. راقب شاشات العرض الإلكترونية التي ستُظهر رقم تذكرتكم ب-057 عند استدعائكم.'
  },
  {
   nationalId: '9876543210',
   embedding: [1.0093696117401123,
    0.8050844073295593,
    -0.740244448184967,
    -0.06663388758897781,
    -1.0908044576644897,
    2.3603901863098145,
    0.8006826043128967,
    -0.47773510217666626,
    -0.30381137132644653,
    1.2622734308242798,
    -0.47021177411079407,
    -1.0005172491073608,
    0.24975910782814026,
    -1.7044897079467773,
    0.6414543986320496,
    0.3101979196071625,
    0.10739842802286148,
    0.6633414030075073,
    -1.9201232194900513,
    0.1276407390832901,
    0.12181446701288223,
    1.6557353734970093,
    -2.455913782119751,
    0.7111371159553528,
    1.2864943742752075,
    0.010144024156033993,
    1.050336480140686,
    1.3618876934051514,
    1.6059765815734863,
    -0.9246944189071655,
    1.0010170936584473,
    -1.183394193649292,
    0.2963210940361023,
    -2.4261677265167236,
    -2.0092732906341553,
    -1.5836124420166016,
    -0.98919278383255,
    -0.47609978914260864,
    2.4440414905548096,
    -1.3034433126449585,
    -0.24593161046504974,
    3.0441296100616455,
    -1.4698094129562378,
    1.02659273147583,
    0.10976488143205643,
    0.15942448377609253,
    0.9708523750305176,
    3.1217315196990967,
    0.05697671324014664,
    1.15317964553833,
    0.5991790294647217,
    -2.0924155712127686,
    1.1755162477493286,
    -1.4291514158248901,
    0.09135428816080093,
    -1.6364449262619019,
    -0.23014533519744873,
    -0.5815358757972717,
    -1.5347181558609009,
    -4.4694504737854,
    0.5910495519638062,
    0.1278465986251831,
    0.02428031899034977,
    -0.5757381916046143,
    0.2174651175737381,
    0.2020900696516037,
    -1.0439704656600952,
    1.2586888074874878,
    0.3836139738559723,
    -2.8100221157073975,
    -1.5926018953323364,
    0.25548115372657776,
    0.3496409058570862,
    0.09005170315504074,
    -0.44116780161857605,
    -0.23027269542217255,
    -0.634490966796875,
    1.2278752326965332,
    -1.0938369035720825,
    0.49019601941108704,
    -0.39237821102142334,
    -0.7612258791923523,
    -0.12107905745506287,
    1.5568617582321167,
    0.05344364792108536,
    -1.2330173254013062,
    1.2692208290100098,
    -1.7087818384170532,
    1.2441567182540894,
    -0.7688520550727844,
    1.3665200471878052,
    1.1200281381607056,
    -2.1034622192382812,
    0.08863483369350433,
    0.37108683586120605,
    -2.8161985874176025,
    1.730908751487732,
    0.5162725448608398,
    1.1356874704360962,
    -0.2599867582321167,
    1.3571088314056396,
    -1.0437463521957397,
    -0.1266629844903946,
    -0.445313423871994,
    0.09123162180185318,
    2.9567904472351074,
    3.472491979598999,
    0.6096968650817871,
    -0.4536096751689911,
    -0.793965756893158,
    -2.7262744903564453,
    -0.23141607642173767,
    -0.4350195527076721,
    -0.7658829092979431,
    -0.8253780603408813,
    2.4866154193878174,
    -0.3843819797039032,
    0.595984935760498,
    0.32550519704818726,
    -0.37915560603141785,
    0.37017446756362915,
    1.3919929265975952,
    0.9556247591972351,
    0.33193230628967285,
    0.9063632488250732,
    0.13966502249240875,
    1.0068864822387695,
    1.6377308368682861,
    -2.306999444961548,
    2.176046133041382,
    -1.6571362018585205,
    0.6428261995315552,
    -0.6116575002670288,
    -0.0358600914478302,
    0.7826824188232422,
    -0.3846987783908844,
    1.7925703525543213,
    -1.4520864486694336,
    0.6001302003860474,
    0.7900547385215759,
    -1.0696216821670532,
    1.3198661804199219,
    0.8393005132675171,
    -2.2451517581939697,
    -0.8776022791862488,
    0.46402299404144287,
    -2.7009103298187256,
    -0.7421018481254578,
    0.3632325232028961,
    -1.9070353507995605,
    1.1104326248168945,
    -1.0884753465652466,
    0.3661346137523651,
    2.8989899158477783,
    -0.6694677472114563,
    -2.0998382568359375,
    -0.34491896629333496,
    -2.8812451362609863,
    0.37692636251449585,
    -0.4896649420261383,
    1.8924537897109985,
    -1.8276128768920898,
    -0.5174847841262817,
    0.3424593508243561,
    -2.373631477355957,
    -1.2452197074890137,
    -0.8736635446548462,
    -0.6844871044158936,
    -0.9040351510047913,
    0.07761482894420624,
    -2.0028252601623535,
    1.4326213598251343,
    -0.4291955530643463,
    -0.3001820147037506,
    -0.5711503028869629,
    -1.2104954719543457,
    -2.3433828353881836,
    -0.9469620585441589,
    -3.4238626956939697,
    1.1570652723312378,
    -0.3678475022315979,
    -2.499678134918213,
    -0.1371430903673172,
    2.250251293182373,
    -1.3017008304595947,
    -0.5285658836364746,
    -1.2394834756851196,
    0.6468186378479004,
    0.23360919952392578,
    -0.38919079303741455,
    -0.12244284898042679,
    1.6462311744689941,
    -0.25642821192741394,
    1.0567266941070557,
    0.0199419092386961,
    0.4481552243232727,
    1.512253761291504,
    1.468376636505127,
    -0.042262643575668335,
    0.8663493990898132,
    0.18383829295635223,
    2.277981758117676,
    1.1774306297302246,
    -0.24558962881565094,
    -0.31982752680778503,
    1.397135615348816,
    -3.5498077869415283,
    -1.2202003002166748,
    -2.0542221069335938,
    0.2603994607925415,
    0.3485463261604309,
    1.3214420080184937,
    -2.9889464378356934,
    -0.8197647333145142,
    2.022963762283325,
    -2.8313794136047363,
    0.627087414264679,
    1.7792909145355225,
    -1.2048431634902954,
    -0.6662930250167847,
    -0.39891836047172546,
    -1.6074011325836182,
    -0.556514322757721,
    2.0298702716827393,
    -0.682163655757904,
    -0.7245293259620667,
    0.7788316607475281,
    0.6464661955833435,
    -1.9017174243927002,
    -0.19579632580280304,
    0.5252694487571716,
    -0.9197145700454712,
    -0.1402329057455063,
    0.901665449142456,
    -3.519735336303711,
    -0.777216911315918,
    1.156820297241211,
    -3.351919174194336,
    1.216788411140442,
    0.11601585149765015,
    -1.4960548877716064,
    -0.5696336030960083,
    0.8887473344802856,
    0.8445658087730408,
    -0.8915752172470093,
    1.9582282304763794,
    1.1398266553878784,
    -1.4234793186187744,
    -0.877758800983429,
    2.2056028842926025,
    -1.4628119468688965,
    1.1479887962341309,
    -1.1318069696426392,
    -2.093735694885254,
    -2.8226118087768555,
    -0.0204477421939373,
    -0.33671286702156067,
    1.9107047319412231,
    1.8088483810424805,
    0.5492052435874939,
    1.7526803016662598,
    1.350290060043335,
    0.8331537842750549,
    2.635061264038086,
    -1.4497281312942505,
    -0.8995174169540405,
    0.8106160759925842,
    -0.6252343058586121,
    -0.12595640122890472,
    -1.1437948942184448,
    -1.9197516441345215,
    2.0258240699768066,
    1.1257297992706299,
    -2.3290657997131348,
    -1.926526665687561,
    1.3353815078735352,
    0.22669754922389984,
    -0.8667266368865967,
    -1.376732587814331,
    1.7265372276306152,
    -1.2803272008895874,
    -1.1288490295410156,
    0.6221833229064941,
    -2.8716330528259277,
    -2.3998122215270996,
    -2.427870035171509,
    -2.684629201889038,
    -3.0484020709991455,
    0.04608968645334244,
    0.9186304807662964,
    0.7629183530807495,
    -0.99167400598526,
    1.5091065168380737,
    0.6347317695617676,
    1.2510775327682495,
    -3.085789442062378,
    0.49878984689712524,
    -1.2049757242202759,
    -0.7342711091041565,
    0.6368622183799744,
    1.5459624528884888,
    -0.7010650038719177,
    0.15808798372745514,
    2.860764503479004,
    -1.05751371383667,
    -2.40795636177063,
    -0.022505465894937515,
    0.7938188910484314,
    3.3183372020721436,
    -1.3686221837997437,
    1.1646045446395874,
    1.6346068382263184,
    1.7925817966461182,
    0.44702398777008057,
    1.110458493232727,
    -0.49847906827926636,
    -0.3207228481769562,
    2.146576166152954,
    1.2212417125701904,
    0.049428459256887436,
    0.27451056241989136,
    -0.4669070541858673,
    3.560833692550659,
    -0.4541705250740051,
    -1.4584206342697144,
    0.5694044828414917,
    -1.4682152271270752,
    -1.3876510858535767,
    2.6189842224121094,
    0.7378121018409729,
    0.160747230052948,
    0.5106872320175171,
    0.14315246045589447,
    -2.7541956901550293,
    -1.3042219877243042,
    -1.8182454109191895,
    -1.2632052898406982,
    1.0427392721176147,
    -0.7731046080589294,
    -0.9457107186317444,
    -0.12629282474517822,
    -2.2785868644714355,
    2.338242769241333,
    4.1242547035217285,
    -0.3028315603733063,
    -0.8883019685745239,
    1.2145994901657104,
    0.3224225640296936,
    -0.6922718286514282,
    0.09815029799938202,
    -0.13065272569656372,
    -2.9220242500305176,
    0.5252747535705566,
    -0.7629359364509583,
    -2.07353138923645,
    -0.44637855887413025,
    0.3243129253387451,
    2.5142834186553955,
    1.0031161308288574,
    -2.738701581954956,
    -0.041562266647815704,
    0.9620621204376221,
    -3.9476993083953857,
    -0.9248559474945068,
    -0.032568685710430145,
    0.0365588404238224,
    1.0504859685897827,
    -1.3163278102874756,
    1.4954241514205933,
    0.2400251179933548,
    1.5960988998413086,
    -2.0477774143218994,
    0.1874304711818695,
    -0.8875367641448975,
    -0.32323840260505676,
    1.2079156637191772,
    -0.7655402421951294,
    -0.05595063045620918,
    -2.561519145965576,
    -1.7776213884353638,
    -1.0756347179412842,
    1.4813224077224731,
    0.60890132188797,
    -0.26440393924713135,
    -0.9169477820396423,
    2.1272566318511963,
    -0.3895913362503052,
    0.007215121760964394,
    0.04929625615477562,
    1.6152139902114868,
    -0.17665202915668488,
    0.03756577894091606,
    -0.49399569630622864,
    -2.3783445358276367,
    -0.09867233783006668,
    2.041356325149536,
    -1.1113998889923096,
    -0.7210216522216797,
    -1.3254737854003906,
    -1.823957085609436,
    -4.022830963134766,
    0.16238591074943542,
    1.363991141319275,
    -1.0915234088897705,
    -0.6513496041297913,
    0.22853103280067444,
    0.6987200975418091,
    -0.8455509543418884,
    0.3280884027481079,
    0.18181036412715912,
    0.2241191864013672,
    -0.7270497679710388,
    2.0725598335266113,
    0.4509063959121704,
    0.7187333703041077,
    -0.29595619440078735,
    1.4152158498764038,
    -2.161423444747925,
    0.8302633762359619,
    0.10082367062568665,
    -1.3938239812850952,
    -3.8963863849639893,
    -1.1947938203811646,
    -1.3587368726730347,
    0.5386388301849365,
    -0.31993529200553894,
    -1.921919345855713,
    -1.1300057172775269,
    0.8292157649993896,
    0.947960615158081,
    -0.467752069234848,
    -0.5856060981750488,
    -1.428654432296753,
    -0.26790738105773926,
    0.2912461459636688,
    0.6942997574806213,
    -1.2449982166290283,
    0.18458956480026245,
    -0.8765536546707153,
    0.7412621974945068,
    -0.03315562754869461,
    -1.0667555332183838,
    -2.5323541164398193,
    0.5843154788017273,
    3.404169797897339,
    -1.8893039226531982,
    -3.6585280895233154,
    0.09366083890199661,
    0.07613377273082733,
    -1.527195692062378,
    -0.7037433981895447,
    0.39148440957069397,
    -2.058650255203247,
    0.49677538871765137,
    -1.4389665126800537,
    -0.3832092583179474,
    -0.2547858655452728,
    -0.33039286732673645,
    1.7458587884902954,
    -2.8512215614318848,
    3.746469020843506,
    -1.0931565761566162,
    0.8858858346939087,
    0.2405276596546173,
    1.1590238809585571,
    2.3518097400665283,
    1.628675937652588,
    -0.10676146298646927,
    0.34880921244621277,
    0.5776861310005188,
    -1.2350952625274658,
    -0.25339528918266296,
    1.551469087600708,
    0.24386461079120636,
    1.1709485054016113,
    -1.4651215076446533,
    0.40391916036605835,
    -0.48660942912101746,
    -3.3980462551116943,
    -1.4227333068847656,
    -0.6430671215057373,
    -2.1550235748291016,
    1.50819730758667,
    -0.12643440067768097,
    -1.6851805448532104,
    -0.852637529373169,
    0.190900519490242,
    -1.0293635129928589,
    -1.4121075868606567,
    -0.7521830797195435,
    -0.20878739655017853,
    2.8423988819122314,
    -0.39168769121170044,
    -0.6163060665130615,
    1.2665975093841553,
    -3.054593801498413,
    -0.3867330849170685,
    2.4853224754333496,
    1.1010105609893799,
    0.09087258577346802,
    -1.022840976715088,
    1.795603632926941,
    0.1746329516172409,
    1.43665611743927,
    0.47335824370384216,
    -1.1442865133285522,
    0.4069720506668091,
    2.0077974796295166,
    3.7063305377960205,
    1.237036108970642,
    2.08044695854187,
    -1.0501424074172974],// for face recognition, to login after entering the national id
    fullName: 'ديما اليحيى',
    service: 'إدارة المرور - تجديد الرخصة',
    location: 'مكتب المرور بالرياض - ملز',
    date: '2025-12-07',
    time: '09:00 ص',
    ticketNumber: 'ج-021',
    notes: 'يُرجى التوجه إلى قسم تجديد الرخص في الجناح الأيمن من المبنى. تقع النافذة رقم 8 في نهاية الممر الأول، بالقرب من منطقة الانتظار المخصصة. تابع الشاشة الإلكترونية لظهور رقم تذكرتكم ج-021 عند حلول دوركم.'
  }
];

// Cosine similarity helper
function cosineSimilarity(a, b) {
  if (!Array.isArray(a) || !Array.isArray(b) || a.length !== b.length) return 0;
  let dot = 0;
  let normA = 0;
  let normB = 0;
  for (let i = 0; i < a.length; i++) {
    const x = Number(a[i]) || 0;
    const y = Number(b[i]) || 0;
    dot += x * y;
    normA += x * x;
    normB += y * y;
  }
  if (normA === 0 || normB === 0) return 0;
  return dot / (Math.sqrt(normA) * Math.sqrt(normB));
}

// ---- Routes ----

// Check if national ID exists
app.post('/api/check-id', (req, res) => {
  const { nationalId } = req.body;

  if (!nationalId) {
    return res.status(400).json({ ok: false, message: 'National ID is required.' });
  }

  const appointment = appointments.find(a => a.nationalId === nationalId);

  if (!appointment) {
    return res.status(404).json({ ok: false, message: 'No appointment found for this ID.' });
  }

  // Don't send details yet (only after verification)
  res.json({ ok: true, message: 'ID found. Choose verification method.' });
});

// Real selfie verification (embedding comparison)
app.post('/api/verify-selfie', upload.single('image'), async (req, res) => {
  const { nationalId } = req.body;

  const appointment = appointments.find(a => a.nationalId === nationalId);
  if (!appointment) {
    return res.status(404).json({ ok: false, message: 'Appointment not found.' });
  }

  if (!req.file) {
    return res.status(400).json({ ok: false, message: 'No image provided.' });
  }

  const tempPath = path.join(uploadsDir, `selfie_${Date.now()}.jpg`);
  try {
    // Save uploaded buffer to temp file for Python
    fs.writeFileSync(tempPath, req.file.buffer);

    // Call Python embedding generator
    const embedScript = path.join(__dirname, 'embed_face.py');
    const pythonCmd = `python "${embedScript}" "${tempPath}"`;
    const { stdout, stderr } = await execAsync(pythonCmd, { cwd: __dirname, maxBuffer: 10 * 1024 * 1024 });

    if (stderr && stderr.trim()) {
      console.warn('Python stderr:', stderr);
    }

    let result;
    try {
      result = JSON.parse(stdout);
    } catch (e) {
      return res.status(500).json({ ok: false, message: 'Failed to parse embedding output.' });
    }

    if (!result.ok || !Array.isArray(result.embedding)) {
      return res.status(400).json({ ok: false, message: result.message || 'Failed to generate embedding.' });
    }

    const sim = cosineSimilarity(appointment.embedding, result.embedding);
    const confidence = sim; // similarity in [0,1]
    const threshold = 0.65; // accept if similarity >= 65%

    if (confidence >= threshold) {
      return res.json({
        ok: true,
        message: `Selfie verified (confidence ${(confidence * 100).toFixed(1)}%)`,
        appointment
      });
    }

    return res.status(400).json({
      ok: false,
      message: `Face does not match (confidence ${(confidence * 100).toFixed(1)}%)`
    });
  } catch (err) {
    console.error('Verification error:', err.message);
    return res.status(500).json({ ok: false, message: 'Error during face verification.' });
  } finally {
    try {
      if (fs.existsSync(tempPath)) fs.unlinkSync(tempPath);
    } catch (e) {
      // ignore cleanup errors
    }
  }
});

// Simulated fingerprint verification
app.post('/api/verify-fingerprint', (req, res) => {
  const { nationalId } = req.body;

  const appointment = appointments.find(a => a.nationalId === nationalId);
  if (!appointment) {
    return res.status(404).json({ ok: false, message: 'Appointment not found.' });
  }

  // A real fingerprint scanner would NOT be handled here with just a browser.
  // For now, we just simulate success.
  res.json({
    ok: true,
    message: 'Fingerprint verified successfully.',
    appointment
  });
});

// Start server
app.listen(PORT, () => {
  console.log(`Gov entrance server running at http://localhost:${PORT}`);
});
